# Publishing AnyCowork to PyPI

This guide explains how to publish AnyCowork to PyPI for easy installation.

## Prerequisites

1. **PyPI Account**: Create account at https://pypi.org/account/register/
2. **API Token**: Generate at https://pypi.org/manage/account/token/
3. **Build Tools**: `pip install build twine`

## Preparation

### 1. Update Version

Edit `server/pyproject.toml`:
```toml
[project]
version = "0.1.1"  # Increment version
```

### 2. Build Web Frontend

```bash
cd web
npm install
npm run build
```

### 3. Copy to Server Static

```bash
cd ../server
rm -rf app/static/*
mkdir -p app/static
cp -r ../frontend/dist/* app/static/
```

### 4. Verify MANIFEST.in

Ensure `server/MANIFEST.in` includes:
```
recursive-include app/static *
include README.md
include LICENSE
```

## Building

### 1. Clean Previous Builds

```bash
cd server
rm -rf dist/ build/ *.egg-info
```

### 2. Build Package

```bash
python -m build
```

This creates:
- `dist/anycowork-0.1.1.tar.gz` (source distribution)
- `dist/anycowork-0.1.1-py3-none-any.whl` (wheel)

### 3. Verify Package Contents

```bash
# Check wheel contents
unzip -l dist/anycowork-0.1.1-py3-none-any.whl

# Should include:
# - app/*.py (Python code)
# - app/static/* (Web UI files)
# - anycowork-0.1.1.dist-info/* (metadata)
```

## Testing Locally

### 1. Install in Virtual Environment

```bash
python -m venv test-env
source test-env/bin/activate  # or test-env\Scripts\activate on Windows
pip install dist/anycowork-0.1.1-py3-none-any.whl
```

### 2. Test Commands

```bash
# Test server
anycowork --ws ~/test-workspace

# Test desktop
anycowork-desktop

# Verify static files served
curl http://localhost:8080/
```

### 3. Clean Up

```bash
deactivate
rm -rf test-env
```

## Publishing

### 1. Configure PyPI Token

Create `~/.pypirc`:
```ini
[pypi]
username = __token__
password = pypi-AgEIcHlwaS5vcmcC...  # Your API token
```

Or use environment variable:
```bash
export TWINE_USERNAME=__token__
export TWINE_PASSWORD=pypi-AgEIcHlwaS5vcmcC...
```

### 2. Upload to Test PyPI (Recommended First)

```bash
# Upload to test.pypi.org
twine upload --repository testpypi dist/*

# Test installation
pip install --index-url https://test.pypi.org/simple/ anycowork
```

### 3. Upload to PyPI

```bash
twine upload dist/*
```

### 4. Verify Upload

Visit: https://pypi.org/project/anycowork/

## Post-Publication

### 1. Test Installation

```bash
pip install anycowork
anycowork-desktop
```

### 2. Update Documentation

Update README.md with installation instructions:
```markdown
## Installation

```bash
pip install anycowork
```

## Usage

```bash
# Run as server
anycowork --ws ~/anycowork-workspace

# Run as desktop app
anycowork-desktop
```
```

### 3. Create GitHub Release

```bash
git tag v0.1.1
git push origin v0.1.1
```

Create release on GitHub with:
- Release notes
- Changelog
- Link to PyPI package

## Automation with GitHub Actions

Create `.github/workflows/publish.yml`:

```yaml
name: Publish to PyPI

on:
  release:
    types: [published]

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Build web frontend
      run: |
        cd web
        npm install
        npm run build
    
    - name: Copy to server static
      run: |
        cd server
        rm -rf app/static/*
        mkdir -p app/static
        cp -r ../frontend/dist/* app/static/
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install build tools
      run: |
        python -m pip install --upgrade pip
        pip install build twine
    
    - name: Build package
      run: |
        cd server
        python -m build
    
    - name: Publish to PyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        cd server
        twine upload dist/*
```

Add `PYPI_API_TOKEN` to GitHub repository secrets.

## Version Management

### Semantic Versioning

Follow semver: `MAJOR.MINOR.PATCH`

- **MAJOR**: Breaking changes
- **MINOR**: New features (backward compatible)
- **PATCH**: Bug fixes

### Pre-releases

For alpha/beta versions:
```toml
version = "0.2.0a1"  # Alpha
version = "0.2.0b1"  # Beta
version = "0.2.0rc1" # Release candidate
```

## Troubleshooting

### Static Files Not Included

Check:
1. `MANIFEST.in` includes `recursive-include app/static *`
2. `pyproject.toml` has `include = ["app/static/**/*"]`
3. Files exist in `app/static/` before building

### Import Errors After Installation

Ensure all dependencies in `pyproject.toml`:
```toml
dependencies = [
    "fastapi>=0.104.0",
    "uvicorn[standard]>=0.24.0",
    # ... all required packages
]
```

### Large Package Size

Exclude unnecessary files in `pyproject.toml`:
```toml
[tool.hatch.build.targets.wheel]
exclude = [
    "app/**/*.pyc",
    "app/**/__pycache__",
    "app/**/*.log",
]
```

## Best Practices

1. **Test Locally**: Always test installation before publishing
2. **Use Test PyPI**: Test uploads on test.pypi.org first
3. **Version Bumping**: Use tools like `bump2version`
4. **Changelog**: Maintain CHANGELOG.md
5. **Documentation**: Keep README.md up to date
6. **Security**: Never commit API tokens
7. **CI/CD**: Automate with GitHub Actions

## Resources

- PyPI: https://pypi.org/
- Test PyPI: https://test.pypi.org/
- Packaging Guide: https://packaging.python.org/
- Twine Docs: https://twine.readthedocs.io/
