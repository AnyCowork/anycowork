# AnyCowork Desktop Distribution

This document explains how to build and distribute AnyCowork as a desktop application.

## Architecture

```
┌─────────────────────────────────────────┐
│     PyInstaller Executable              │
│  ┌───────────────────────────────────┐  │
│  │   Python Runtime + Dependencies   │  │
│  │   - FastAPI Backend               │  │
│  │   - WebSocket Gateway             │  │
│  │   - Federation Node               │  │
│  │   - SQLite Database               │  │
│  └───────────────────────────────────┘  │
│  ┌───────────────────────────────────┐  │
│  │   Static Web UI (Bundled)         │  │
│  │   - React + Vite Build            │  │
│  │   - Served by FastAPI             │  │
│  └───────────────────────────────────┘  │
└─────────────────────────────────────────┘
         Opens in: Browser or Native Window
```

## Distribution Methods

### 1. PyPI Package (Recommended for Developers)

Install from PyPI:
```bash
pip install anycowork

# Run as server
anycowork --ws ~/anycowork-workspace

# Run as desktop app (opens in browser)
anycowork-desktop

```

### 2. Standalone Executable (Recommended for End Users)

Build standalone executable with PyInstaller:

**Linux/macOS:**
```bash
cd server
chmod +x build-desktop.sh
./build-desktop.sh
```

**Windows:**
```cmd
cd server
build-desktop.bat
```

**Output:**
- Linux: `server/dist/anycowork-desktop`
- macOS: `server/dist/AnyCowork.app`
- Windows: `server/dist/anycowork-desktop.exe`

### 3. Docker Container

```bash
docker build -t anycowork .
docker run -p 8080:8080 -v ~/anycowork-workspace:/workspace anycowork
```

## Building for Distribution

### Prerequisites

1. **Python 3.10+** with pip
2. **Node.js 18+** with npm
3. **PyInstaller**: `pip install pyinstaller`

### Build Steps

1. **Build web frontend:**
   ```bash
   cd web
   npm install
   npm run build
   ```

2. **Copy to server static:**
   ```bash
   cd ../server
   rm -rf app/static/*
   cp -r ../frontend/dist/* app/static/
   ```

3. **Build executable:**
   ```bash
   ./build-desktop.sh  # or build-desktop.bat on Windows
   ```

### Publishing to PyPI

1. **Update version** in `server/pyproject.toml`

2. **Build package:**
   ```bash
   cd server
   pip install build twine
   python -m build
   ```

3. **Upload to PyPI:**
   ```bash
   twine upload dist/*
   ```

4. **Test installation:**
   ```bash
   pip install anycowork
   anycowork-desktop
   ```

## Multi-Node Federation

### Connecting Multiple Instances

1. **Start first node:**
   ```bash
   anycowork-desktop
   # Note the IP address (e.g., 192.168.1.100)
   ```

2. **Start second node on another PC:**
   ```bash
   anycowork-desktop
   ```

3. **Connect nodes:**
   - Open Settings → Federation
   - Click "Connect to Node"
   - Enter: `192.168.1.100:18790`
   - Nodes will sync automatically

### Federation Features

- **Shared Sessions**: Access conversations from any device
- **Distributed Tasks**: Offload heavy tasks to powerful nodes
- **Real-time Sync**: Changes propagate instantly
- **Offline Support**: Local-first design works without network

### Network Configuration

**Default Ports:**
- REST API: `8080`
- WebSocket Gateway: `18789`
- Federation: `18790`

**Firewall Rules:**

Linux (ufw):
```bash
sudo ufw allow 18789/tcp
sudo ufw allow 18790/tcp
```

Windows (PowerShell as Admin):
```powershell
New-NetFirewallRule -DisplayName "AnyCowork Gateway" -Direction Inbound -LocalPort 18789 -Protocol TCP -Action Allow
New-NetFirewallRule -DisplayName "AnyCowork Federation" -Direction Inbound -LocalPort 18790 -Protocol TCP -Action Allow
```

macOS:
```bash
# Allow in System Preferences → Security & Privacy → Firewall
```

## Platform-Specific Packaging

### Linux

**AppImage:**
```bash
# Install appimagetool
wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
chmod +x appimagetool-x86_64.AppImage

# Create AppDir structure
mkdir -p AnyCowork.AppDir/usr/bin
cp dist/anycowork-desktop AnyCowork.AppDir/usr/bin/
# Add .desktop file and icon
./appimagetool-x86_64.AppImage AnyCowork.AppDir
```

**Debian Package:**
```bash
# Install fpm
gem install fpm

# Create .deb
fpm -s dir -t deb -n anycowork -v 0.1.0 \
  --prefix /usr/local/bin \
  dist/anycowork-desktop=/usr/local/bin/anycowork-desktop
```

### macOS

**DMG Installer:**
```bash
# Create DMG from .app bundle
hdiutil create -volname "AnyCowork" -srcfolder dist/AnyCowork.app -ov -format UDZO AnyCowork.dmg
```

**Code Signing:**
```bash
# Sign the app
codesign --deep --force --verify --verbose --sign "Developer ID Application: Your Name" dist/AnyCowork.app

# Notarize
xcrun notarytool submit AnyCowork.dmg --apple-id your@email.com --password app-specific-password --team-id TEAMID
```

### Windows

**NSIS Installer:**
```nsis
; anycowork-installer.nsi
!define APP_NAME "AnyCowork"
!define APP_VERSION "0.1.0"

OutFile "AnyCowork-Setup.exe"
InstallDir "$PROGRAMFILES\AnyCowork"

Section "Install"
  SetOutPath "$INSTDIR"
  File "dist\anycowork-desktop.exe"
  CreateShortcut "$DESKTOP\AnyCowork.lnk" "$INSTDIR\anycowork-desktop.exe"
  CreateShortcut "$SMPROGRAMS\AnyCowork.lnk" "$INSTDIR\anycowork-desktop.exe"
SectionEnd
```

Build:
```cmd
makensis anycowork-installer.nsi
```

**Inno Setup:**
```ini
[Setup]
AppName=AnyCowork
AppVersion=0.1.0
DefaultDirName={pf}\AnyCowork
DefaultGroupName=AnyCowork
OutputBaseFilename=AnyCowork-Setup

[Files]
Source: "dist\anycowork-desktop.exe"; DestDir: "{app}"

[Icons]
Name: "{group}\AnyCowork"; Filename: "{app}\anycowork-desktop.exe"
Name: "{commondesktop}\AnyCowork"; Filename: "{app}\anycowork-desktop.exe"
```

## Configuration

### User Data Locations

- **Windows**: `%APPDATA%\anycowork`
- **macOS**: `~/Library/Application Support/anycowork`
- **Linux**: `~/.local/share/anycowork`

### Environment Variables

Create `.env` in workspace directory:

```env
# AI Provider
ANTHROPIC_API_KEY=sk-ant-...
OPENAI_API_KEY=sk-...
GEMINI_API_KEY=...

# Federation
FEDERATION__ENABLED=true
FEDERATION__NODE_NAME=my-desktop
FEDERATION__DISCOVERY_ENABLED=true

# Messaging (optional)
TELEGRAM_BOT_TOKEN=...
WHATSAPP_BRIDGE_URL=...
```


## Troubleshooting

### Executable Won't Start

1. Check Python version: `python --version` (must be 3.10+)
2. Rebuild with verbose: `pyinstaller anycowork-desktop.spec --clean --log-level DEBUG`
3. Check logs in workspace directory

### Can't Connect to Other Nodes

1. Verify firewall allows ports 18789, 18790
2. Check both nodes on same network
3. Verify federation enabled in settings
4. Check logs: `<workspace>/logs/`

### High Memory Usage

- Reduce concurrent sessions in settings
- Disable unused messaging platforms
- Clear old conversation history

## License

MIT - See LICENSE file
